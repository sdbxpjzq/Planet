获得读锁流程：
![](https://youpaiyun.zongqilive.cn/image/20210121163627.png)

1、基于资源ID创建临时序号读锁节点 /lock/888.R0000000002 Read 

2、获取 /lock 下所有⼦节点，判断其最⼩的节点是否为读锁，如果是则获锁成功 
3、最⼩节点不是读锁，则阻塞等待。添加lock/ ⼦节点变更监听。 
4、当节点变更监听触发，执⾏第2步


获得写锁：
1、基于资源ID创建临时序号写锁节点
/lock/888.R0000000002 Write 

2、获取 /lock 下所有⼦节点，判断其最⼩的节点是否为⾃⼰，如果是则获锁成功 
3、最⼩节点不是⾃⼰，则阻塞等待。添加lock/ ⼦节点变更监听。 
4、当节点变更监听触发，执⾏第2步

释放锁：
读取完毕后，⼿动删除临时节点，如果获锁期间宕机，则会在会话失效后⾃动删除。


关于⽺群效应：
在等待锁获得期间，所有等待节点都在监听 Lock节点，⼀但lock 节点变更所有等待节点都会 被触发，然后在同时反查Lock ⼦节点。如果等待对例过⼤会使⽤Zookeeper承受⾮常⼤的流 量压⼒。
![](https://youpaiyun.zongqilive.cn/image/20210121163720.png)

为了改善这种情况，可以采⽤监听链表的⽅式，每个等待对列只监听前⼀个节点，如果前⼀个 节点释放锁的时候，才会被触发通知。这样就形成了⼀个监听链表。
![](https://youpaiyun.zongqilive.cn/image/20210121163729.png)
