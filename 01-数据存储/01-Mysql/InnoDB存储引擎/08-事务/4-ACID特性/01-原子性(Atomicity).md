## 原子性(Atomicity)

事务中的语句要么全执行，要么全不执行



## 原理

实现主要基于`undo log`, 也称回滚日志，主要用于记录数据被修改前的信息.

主要记录数据的逻辑变化。所以需要将之前的操作都记录下来，然后在发生错误或执行事务回滚时才能保证回滚到之前的操作。



#### 请求过程是怎么实现的？

比如当写请求为 insert 操作进入到数据库服务层时，会先在缓冲池下面的写缓冲中进行数据的写入，然后先把写请求的物理语言写入到 read log中，并记录一条删除当前语句的逻辑语句到 undo log中。最后由 MySQL 后台线程定期刷新数据到磁盘里面。

但是这个写缓冲在5.5之前叫 **「 \**插入缓冲\**」**，只针对 insert 优化; 现在对 update 和 delete更新操作都有效。现在叫做：**「\**写缓冲\**」**

#### 这个写缓冲有什么好处呢？

避免频繁磁盘I/O的写操作，如果没得这玩意，需要在磁盘里面读到数据，然后才能做数据上面的修改。

但大多数场景下都是读多写少，如果在高并发的场景下，通过打包批次处理就能有效避免，在写操作处理时资源开销而影响到大量得读请求。





#### **MySQL 怎么保证原子性的？**

我们知道如果想要保证事务的原子性，就需要在异常发生时，对已经执行的操作进行**回滚**，在 MySQL 中，恢复机制是通过 **回滚日志（undo log）** 实现的，所有事务进行的修改都会先先记录到这个回滚日志中，然后再执行相关的操作。如果执行过程中遇到异常的话，我们直接利用 **回滚日志** 中的信息将数据回滚到修改之前的样子即可！并且，回滚日志会先于数据持久化到磁盘上。这样就保证了即使遇到数据库突然宕机等情况，当用户再次启动数据库的时候，数据库还能够通过查询回滚日志来回滚将之前未完成的事务。

