**2.3.1 Saga 是什么？**

1987年普林斯顿大学的Hector Garcia-Molina和Kenneth Salem发表了一篇Paper Sagas，讲述的是如何处理long lived transaction（长活事务）。Saga是一个长活事务可被分解成可以交错运行的子事务集合。论文见这里。 

简单来说，Saga将一个长事务（T）分解成一系列Sub事务（Ti），每个Sub事务都有对应的补偿动作（Ci），用于撤销Ti事务产生的影响。Sub事务是直接提交到库，在出现异常时，逆向进行补偿。

因此Saga事务的组成有2种： 

- T1, T2, T3, ..., Tn
- T1, T2, ..., Tj, Cj,..., C2, C1，其中0 < j < n

第一种就是正常提交的情况，第二种在提交Tj事务出现异常，开始逆向补偿的情况。

Saga模式是Seata提供的长事务解决方案。例如全局事务中涉及到外部系统，无法管理它的资源管理器，让它改造成TCC也不好实行，这时就可以采用此类方案。





**2.3.2 整体机制**

在Saga模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。

![](https://youpaiyun.zongqilive.cn/image/20210124104759.png)

上图中对于多个分支事务，省略了多次出现的 2.* 步骤。对于全局事务执行过程中业务应用宕机情况，业务应用集群中对等节点会通过从TC获取相关会话，从DB加载详细信息来恢复状态机。



**2.3.3 特点**

- **优点：**一阶段提交本地事务，无锁，高性能；事件驱动架构，参与者可异步执行，高吞吐；补偿服务易于实现。
- **缺点：**不保证隔离性。