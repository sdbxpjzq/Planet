基于消息队列来实现最终一致性的方案，一般来说有两种方式，`基于本地消息表`和`依赖 MQ 本身的事务消息`。



## 基于MQ

1. 业务发起方，调用远程接口，向 MQ 发送一条半事务消息，MQ 收到消息之后会返回给生产者一个 ACK。
2. 生产者收到 ACK 之后，去执行事务，但是事务还没有提交。
3. 生产者会根据事务的执行结果来决定发送 commit 提交或者 rollback 回滚到 MQ。
4. 这一点是发生异常的情况，比如生产者宕机或者其他异常导致 MQ 长时间没有收到 commit 或者 rollback 的消息，这时候 MQ 会发起状态回查。
5. MQ 如果收到的是 commit 的话就会去投递消息，消费者正常消费消息即可。如果是 rollback 的话，则会在设置的固定时间期限内去删除消息。

![](https://youpaiyun.zongqilive.cn/image/20210124101622.png)

![](https://youpaiyun.zongqilive.cn/image/20200917195742.png)



