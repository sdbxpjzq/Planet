## 两阶段提交（3PC）

1. can commit 引入超时机制, 超时回滚 (相比 2PC多了这个操作)
2. prepare commit  `引入超时机制` 超时 回滚
3. do commit 超时提交



**引入超时机制：**

- 如果在CanCommit 准备阶段等待超时，则自动中止；
- 如果在PreCommit预提交阶段等待超时，则自动提交。



三阶段提交是在二阶段提交上的改进版本，3PC最关键要解决的就是协调者和参与者同时挂掉的问题，所以3PC把2PC的准备阶段再次一分为二，这样三阶段提交。处理流程如下：

![](https://ae01.alicdn.com/kf/Hf321e50d091b489ebb4efb70d19156ffR.png)

- **阶段一** ==等待超时后会自动中止==

a) 协调者向所有参与者发出包含事务内容的 canCommit 请求，询问是否可以提交事务，并等待所有参与者答复。

b) 参与者收到 canCommit 请求后，如果认为可以执行事务操作，则反馈 yes 并进入预备状态，否则反馈 no。

这个阶段参与者在等待超时后会自动中止



- 阶段二  ==有了超时机制，如果参与者超时未收到 doCommit 命令的话，将会默认去提交事务==。

协调者根据参与者响应情况，有以下两种可能。

**情况1**：所有参与者均反馈 yes，协调者预执行事务

a) 协调者向所有参与者发出 preCommit 请求，进入准备阶段。

b) 参与者收到 preCommit 请求后，执行事务操作，将 undo 和 redo 信息记入事务日志中（但不提交事务）。

c) 各参与者向协调者反馈 ack 响应或 no 响应，并等待最终指令。



**情况2**：只要有一个参与者反馈 no，或者等待超时后协调者尚无法收到所有提供者的反馈，即中断事务

a) 协调者向所有参与者发出 abort 请求。

b) 无论收到协调者发出的 abort 请求，或者在等待协调者请求过程中出现超时，参与者均会中断事务。



- **阶段三**

该阶段进行真正的事务提交，也可以分为以下两种情况。

**情况 1**：所有参与者均反馈 ack 响应，执行真正的事务提交

a) 如果协调者处于工作状态，则向所有参与者发出 do Commit 请求。

b) 参与者收到 do Commit 请求后，会正式执行事务提交，并释放整个事务期间占用的资源。

c) 各参与者向协调者反馈 ack 完成的消息。

d) 协调者收到所有参与者反馈的 ack 消息后，即完成事务提交。



**情况2**：只要有一个参与者反馈 no，或者等待超时后协调组尚无法收到所有提供者的反馈，即回滚事务。

a) 如果协调者处于工作状态，向所有参与者发出 rollback 请求。

b) 参与者使用阶段 1 中的 undo 信息执行回滚操作，并释放整个事务期间占用的资源。

c) 各参与者向协调组反馈 ack 完成的消息。

d) 协调组收到所有参与者反馈的 ack 消息后，即完成事务回滚。









![](https://youpaiyun.zongqilive.cn/image/20210124110245.png)



