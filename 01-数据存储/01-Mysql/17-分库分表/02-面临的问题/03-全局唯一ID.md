在分库分表环境中，由于表中数据同时存在不同数据库中，主键平时使用的自增长将无用武之地，某个分区数据库自生成的ID无法保证全局唯一。因此需要单独设计全局主键，以避免跨库主键重复问题。

## 生成方案

- 

- 

## MySQL多实例主键自增

这个方案就是解决mysql的单点问题，在auto_increment基本上面，设置step步长

![](https://ae01.alicdn.com/kf/H0dbc4f32fe6e48eab879d1183d438debr.jpg)

每台的初始值分别为1,2,3...N，步长为N（这个案例步长为4）

**优点：**

- 解决了单点问题

**缺点：**

- 一旦把步长定好后，就无法扩容；而且单个数据库的压力大，数据库自身性能无法满足高并发

**应用场景：**

- 数据不需要扩容的场景

## 雪花算法

雪花算法生成64位的二进制正整数，然后转换成10进制的数。64位二进制数由如下部分组成：

![](https://ae01.alicdn.com/kf/H280c00f3acc24b44967f9cf829cfe336J.jpg)

- 1位标识符：始终是0
- 41位时间戳：41位时间截不是存储当前时间的时间截，而是存储时间截的差值（当前时间截 - 开始时间截 )得到的值，这里的的开始时间截，一般是我们的id生成器开始使用的时间，由我们程序来指定的
- 10位机器标识码：可以部署在1024个节点，如果机器分机房（IDC）部署，这10位可以由 5位机房ID + 5位机器ID 组成
- 12位序列：毫秒内的计数，12位的计数顺序号支持每个节点每毫秒(同一机器，同一时间截)产生4096个ID序号



**优点：**

- 此方案每秒能够产生409.6万个ID，性能快
- 时间戳在高位，自增序列在低位，整个ID是趋势递增的，按照时间有序递增
- 灵活度高，可以根据业务需求，调整bit位的划分，满足不同的需求

**缺点：**

- 依赖机器的时钟，如果服务器时钟回拨，会导致重复ID生成





### 时钟回拨问题





[参考文章](https://mp.weixin.qq.com/s/8ZWUmlhmP2PR1XGGqjEUQQ)



