## 安全点 Safepoint

程序执行并非在所有地方都能停顿下来开始GC, 只有在特定的位置才能停顿下来开始GC, 这些位置称为`安全点`

通常会根据`是否具有让程序长时间执行的特征`为标准, 比如选择一些执行时间较长的指令作为Safe Point, 如 方法调用, 循环跳转和异常跳转等



这些特定的安全点位置主要有以下几种:

1. 方法返回之前

2. 调用某个方法之后

3. 抛出异常的位置

4. 循环的末尾



如何在发生GC时, 检查所有线程都跑到了最近的安全点停顿下来?

- 主动式中断: 
  - 设置一个中断标志, 各个线程运行到 安全点的时候主动轮询这个标志, 如果中断标志为真, 则将自己进行中断挂起

- 抢先式中断:(目前没有采用了)
  - 首先中断所有线程, 如果还是线程不在安全点, 就恢复线程, 让线程跑到安全点





## 安全区域 (Safe Region)

Safe Point 是对正在执行的线程设定的

但是 程序不执行的时候呢? 例如线程处于Sleep状态或Blocked状态, 这时线程无法响应JVM的中断请求, 无法执行到安全点挂起, JVM也不可能等待线程被唤醒, 对于这种情况, 就需要安全区域解决.



在这个区域内的任意地方开始 GC 都是安全的。

线程在进入 Safe Region 的时候先标记自己已进入了 Safe Region，等到被唤醒时准备离开 Safe Region 时，先检查能

否离开，如果 GC 完成了，那么线程可以离开，否则它必须等待直到收到安全离开的信号为止。

